image: docker:stable

stages:
  - build
  - test
  - deploy

build-php-7.3-cli:
  stage: build
  only:
    refs:
      - master
    changes:
      - 7.3-cli/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - docker build --pull --no-cache -t $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli-$CI_COMMIT_SHORT_SHA 7.3-cli/
    - docker push $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli-$CI_COMMIT_SHORT_SHA

test-php-7.3-cli:
  stage: test
  only:
    refs:
      - master
    changes:
      - 7.3-cli/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    #- docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli-$CI_COMMIT_SHORT_SHA
    - exit 0

deploy-php-7.3-cli:
  stage: deploy
  only:
    refs:
      - master
    changes:
      - 7.3-cli/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli-$CI_COMMIT_SHORT_SHA
    - docker tag $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli-$CI_COMMIT_SHORT_SHA $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli
    - docker push $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli

deploy-php-7.3-cli-to-hub:
  stage: deploy
  only:
    refs:
      - master
    changes:
      - 7.3-cli/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - echo $DOCKER_HUB_PASSWORD |docker login -u $DOCKER_HUB_USER --password-stdin
    - docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli-$CI_COMMIT_SHORT_SHA
    - docker tag $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-cli-$CI_COMMIT_SHORT_SHA $DOCKER_HUB_REPOSITORY:7.3-cli
    - docker push $DOCKER_HUB_REPOSITORY:7.3-cli
    - docker rmi $DOCKER_HUB_REPOSITORY:7.3-cli

build-php-7.3-fpm:
  stage: build
  only:
    refs:
      - master
    changes:
      - 7.3-fpm/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - docker build --pull --no-cache -t $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm-$CI_COMMIT_SHORT_SHA 7.3-fpm/
    - docker push $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm-$CI_COMMIT_SHORT_SHA

test-php-7.3-fpm:
  stage: test
  only:
    refs:
      - master
    changes:
      - 7.3-fpm/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    #- docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm-$CI_COMMIT_SHORT_SHA
    - exit 0

deploy-php-7.3-fpm:
  stage: deploy
  only:
    refs:
      - master
    changes:
      - 7.3-fpm/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm-$CI_COMMIT_SHORT_SHA
    - docker tag $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm-$CI_COMMIT_SHORT_SHA $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm
    - docker push $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm

deploy-php-7.3-fpm-to-hub:
  stage: deploy
  only:
    refs:
      - master
    changes:
      - 7.3-fpm/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - echo $DOCKER_HUB_PASSWORD |docker login -u $DOCKER_HUB_USER --password-stdin
    - docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm-$CI_COMMIT_SHORT_SHA
    - docker tag $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-fpm-$CI_COMMIT_SHORT_SHA $DOCKER_HUB_REPOSITORY:7.3-fpm
    - docker push $DOCKER_HUB_REPOSITORY:7.3-fpm
    - docker rmi $DOCKER_HUB_REPOSITORY:7.3-fpm

build-php-7.3-apache:
  stage: build
  only:
    refs:
      - master
    changes:
      - 7.3-apache/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - docker build --pull --no-cache -t $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache-$CI_COMMIT_SHORT_SHA 7.3-apache/
    - docker push $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache-$CI_COMMIT_SHORT_SHA

test-php-7.3-apache:
  stage: test
  only:
    refs:
      - master
    changes:
      - 7.3-apache/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    #- docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache-$CI_COMMIT_SHORT_SHA
    - exit 0

deploy-php-7.3-apache:
  stage: deploy
  only:
    refs:
      - master
    changes:
      - 7.3-apache/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache-$CI_COMMIT_SHORT_SHA
    - docker tag $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache-$CI_COMMIT_SHORT_SHA $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache
    - docker push $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache

deploy-php-7.3-apache-to-hub:
  stage: deploy
  only:
    refs:
      - master
    changes:
      - 7.3-apache/*
  script:
    - echo $DOCKER_PASSWORD |docker login $DOCKER_REGISTRY -u $DOCKER_USER --password-stdin
    - echo $DOCKER_HUB_PASSWORD |docker login -u $DOCKER_HUB_USER --password-stdin
    - docker pull $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache-$CI_COMMIT_SHORT_SHA
    - docker tag $DOCKER_REGISTRY/$DOCKER_REPOSITORY:7.3-apache-$CI_COMMIT_SHORT_SHA $DOCKER_HUB_REPOSITORY:7.3-apache
    - docker push $DOCKER_HUB_REPOSITORY:7.3-apache
    - docker rmi $DOCKER_HUB_REPOSITORY:7.3-apache
